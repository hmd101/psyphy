# Full WPPM Example: Fitting a Spatially-Varying Covariance Field

This example demonstrates how to use the full Wishart Process Psychophysical Model (WPPM) to fit a spatially-varying covariance field to synthetic 2D data. It visualizes the ground-truth covariance field, the initial prior sample, and the fitted field as ellipsoid contours.

## Mathematical Overview

The **Wishart Process Psychophysical Model (WPPM)** models the local covariance of perceptual encoding as a smooth, spatially-varying field:

$$
\Sigma(x) = U(x) U(x)^T + \text{diag\_term} \cdot I
$$

where $U(x)$ is constructed from a basis expansion (e.g., Chebyshev polynomials) and learned weights $W$. This allows the model to capture both spatial variation and correlations in the encoding noise.

- **Ground-truth field**: Sampled from the Wishart process prior.
- **Data simulation**: Synthetic trials are generated by sampling probe locations and simulating responses using the ground-truth field.
- **Model fitting**: The WPPM is fit to the data using MAP optimization.
- **Visualization**: The covariance field is visualized as a grid of ellipsoid contours for ground-truth, prior sample, and fitted parameters.

## Key Code Blocks

### 1. Model Initialization
```python
from psyphy.model.wppm import WPPM
from psyphy.model.prior import Prior
from psyphy.model.task import OddityTask
from psyphy.model.noise import GaussianNoise

input_dim = 2
basis_degree = 2
extra_dims = 1
lengthscale = 0.5
variance_scale = 0.2

task = OddityTask(slope=1.5)
noise = GaussianNoise(sigma=1.0)
prior = Prior.default(input_dim=input_dim)
model = WPPM(
    input_dim=input_dim,
    prior=prior,
    task=task,
    noise=noise,
    basis_degree=basis_degree,
    extra_dims=extra_dims,
    lengthscale=lengthscale,
    variance_scale=variance_scale,
)
```

### 2. Simulating Data
```python
truth_params = model.init_params(jax.random.PRNGKey(123))
# ...
Sigma_ref = model.local_covariance(truth_params, jnp.array(ref_np))
d = float(model.discriminability(truth_params, (jnp.array(ref_np), jnp.array(probe_np))))
# ...
```

### 3. Fitting the Model
```python
from psyphy.inference.map_optimizer import MAPOptimizer
optimizer = MAPOptimizer(steps=1200, learning_rate=1e-2, momentum=0.9, track_history=True)
init_params = model.init_params(jax.random.PRNGKey(42))
posterior = optimizer.fit(model, data, init_params=init_params)
```

### 4. Visualizing the Covariance Field
```python
def ellipse_contour_from_cov(center, cov, d_threshold, n_points=180):
    L = np.linalg.cholesky(cov)
    angles = np.linspace(0.0, 2.0 * np.pi, n_points, endpoint=False)
    unit = np.stack([np.cos(angles), np.sin(angles)], axis=0)
    contour = center.reshape(2, 1) + d_threshold * (L @ unit)
    return contour.T

# For each grid point:
cov = model.local_covariance(params, jnp.array(center))
contour = ellipse_contour_from_cov(center, cov, d_threshold)
plt.plot(contour[:, 0], contour[:, 1])
```

## Running the Example

Run the script to generate the plots:

```bash
python docs/examples/wppm/full_wppm_fit_example.py
```

This will produce:
- A figure showing the ellipsoid field for the ground-truth, prior sample, and fitted model.
- A learning curve for the MAP optimization.

## Summary
- The full WPPM models a spatially-varying, correlated covariance field using a Wishart process prior.
- The example demonstrates the full pipeline: initialization, data simulation, model fitting, and visualization.
- The key difference from the MVP is the ability to model non-diagonal, spatially-varying covariances.

---

For more details, see the code and comments in `full_wppm_fit_example.py`.
